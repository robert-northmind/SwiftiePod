name: Swift Package CI

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

jobs:
  build-and-test:
    runs-on: macos-26

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Build Swift package
        run: swift build

      - name: Run Swift package tests
        run: swift test

      - name: Build and Run ExampleApp
        working-directory: Examples/ExampleApp/
        run: swift run

      - name: Select iOS Simulator
        run: |
          DEVICE_NAME=$(xcrun simctl list devices available | grep "iPhone" | head -1 | sed 's/^ *//' | sed 's/ (.*//')
          echo "Using simulator: $DEVICE_NAME"
          echo "SIMULATOR_DEVICE=$DEVICE_NAME" >> $GITHUB_ENV

      - name: Build iOS Example App
        run: |
          xcodebuild build-for-testing \
            -project Examples/ExampleIosApp/ExampleIosApp.xcodeproj \
            -scheme ExampleIosApp \
            -destination "platform=iOS Simulator,name=$SIMULATOR_DEVICE" \
            CODE_SIGN_IDENTITY="" \
            CODE_SIGNING_REQUIRED=NO

      - name: Run iOS Example App Tests
        run: |
          xcodebuild test \
            -project Examples/ExampleIosApp/ExampleIosApp.xcodeproj \
            -scheme ExampleIosApp \
            -destination "platform=iOS Simulator,name=$SIMULATOR_DEVICE" \
            -only-testing:ExampleIosAppTests \
            CODE_SIGN_IDENTITY="" \
            CODE_SIGNING_REQUIRED=NO
